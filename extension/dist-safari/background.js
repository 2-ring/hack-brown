var u="https://api.dropcal.ai",v=null;function x(e){v=e}function p(){let e={"Content-Type":"application/json"};return v&&(e.Authorization=`Bearer ${v}`),e}async function f(e){if(!e.ok){let t=await e.json().catch(()=>({error:e.statusText}));throw new Error(t.error||`HTTP ${e.status}`)}return e.json()}async function R(e){let t=await fetch(`${u}/sessions`,{method:"POST",headers:p(),body:JSON.stringify({text:e})});return(await f(t)).session}async function Q(e){let t=await fetch(e);if(!t.ok)throw new Error(`Failed to fetch image: ${t.status}`);let r=await t.blob(),n=new URL(e).pathname.split("/").pop()||"image.png",s=new FormData;s.append("file",r,n);let c={};v&&(c.Authorization=`Bearer ${v}`);let N=await fetch(`${u}/upload`,{method:"POST",headers:c,body:s});return(await f(N)).session}async function W(e){let t=await fetch(`${u}/sessions/${e}`,{method:"GET",headers:p()});return(await f(t)).session}async function V(e){let t=await fetch(`${u}/sessions/${e}/events`,{method:"GET",headers:p()});return f(t)}async function Y(){let e=await fetch(`${u}/auth/profile`,{method:"GET",headers:p()});return(await f(e)).user.preferences||{}}async function q(){let e=await fetch(`${u}/auth/profile`,{method:"GET",headers:p()}),t=await f(e);return{email:t.user.email,display_name:t.user.display_name,photo_url:t.user.photo_url,plan:t.user.plan||"free",primary_calendar_provider:t.user.primary_calendar_provider,preferences:t.user.preferences||{}}}async function Z(e){let t=await fetch(`${u}/auth/preferences`,{method:"PUT",headers:p(),body:JSON.stringify(e)});return f(t)}async function ee(){let e=await fetch(`${u}/calendar/provider/list`,{method:"GET",headers:p()});return f(e)}async function te(e){let t=await fetch(`${u}/calendar/provider/set-primary`,{method:"POST",headers:p(),body:JSON.stringify({provider:e})});await f(t)}async function re(e){let t=await fetch(`${u}/calendar/provider/disconnect`,{method:"POST",headers:p(),body:JSON.stringify({provider:e})});await f(t)}var l=globalThis.chrome,ge=typeof browser<"u",i=ge?browser:l,oe=typeof l<"u"&&"sidePanel"in l,ne=typeof browser<"u"&&"sidebarAction"in browser,D=typeof l<"u"&&typeof l.storage<"u"&&"session"in l.storage,$=typeof l<"u"&&"notifications"in l,ie=typeof l<"u"&&typeof l.action?.openPopup=="function",A=typeof l<"u"&&"alarms"in l;var g="__session:";function se(e){return typeof e=="string"?[`${g}${e}`]:Array.isArray(e)?e.map(t=>`${g}${t}`):Object.keys(e).map(t=>`${g}${t}`)}function ae(e){let t={};for(let[r,o]of Object.entries(e))t[`${g}${r}`]=o;return t}function me(e){let t={};for(let[r,o]of Object.entries(e))r.startsWith(g)&&(t[r.slice(g.length)]=o);return t}var I=new Set,ce=!1;function ye(){ce||(ce=!0,i.storage.local.onChanged.addListener(e=>{if(I.size===0)return;let t={},r=!1;for(let[o,n]of Object.entries(e))o.startsWith(g)&&(t[o.slice(g.length)]=n,r=!0);if(r)for(let o of I)o(t,"session")}))}var le={get(e,t){let r=e===null?null:se(e);i.storage.local.get(r,o=>{t(me(o))})},set(e,t){t?i.storage.local.set(ae(e),t):i.storage.local.set(ae(e))},remove(e,t){let r=se(e);t?i.storage.local.remove(r,t):i.storage.local.remove(r)},clear(e){i.storage.local.get(null,t=>{let r=Object.keys(t).filter(o=>o.startsWith(g));r.length>0?e?i.storage.local.remove(r,e):i.storage.local.remove(r):e?.()})},onChanged:{addListener(e){ye(),I.add(e)}}};function L(){D||le.clear()}function ve(){let e=i.storage.session;return{get(t,r){e.get(t,r)},set(t,r){r?e.set(t,r):e.set(t)},remove(t,r){r?e.remove(t,r):e.remove(t)},clear(t){t?e.clear(t):e.clear()},onChanged:e.onChanged}}var a={local:i.storage.local,session:D?ve():le,onChanged:i.storage.onChanged};var b={create(e,t){$&&i.notifications.create(e,t)},onClicked:$?i.notifications.onClicked:{addListener:e=>{}}};function Pe(){return{isSupported:!0,async open({windowId:e,sessionId:t}){t&&await new Promise(r=>{a.session.set({sidebarSessionId:t},r)}),e&&await i.sidePanel.open({windowId:e})}}}function Se(){return{isSupported:!0,async open({sessionId:e}){e&&await new Promise(t=>{a.session.set({sidebarSessionId:e},t)}),await i.sidebarAction.open()}}}function we(){return{isSupported:!0,async open({sessionId:e}){let t=e?`?session=${e}`:"",r=i.runtime.getURL(`sidebar/sidebar.html${t}`);await i.windows.create({url:r,type:"popup",width:380,height:600})}}}var B=oe?Pe():ne?Se():we();var d={setBadgeText(e){i.action.setBadgeText(e)},setBadgeBackgroundColor(e){i.action.setBadgeBackgroundColor(e)},async tryOpenPopup(){if(ie)try{await i.action.openPopup()}catch{}}};var Xe=1/30,Te=2e3,_="poll-keepalive",U=null,m=new Set,F=new Map;function M(e){U=e,A&&i.alarms.onAlarm.addListener(t=>{t.name})}function P(e){m.add(e),xe(),Ce(e)}function S(e){m.delete(e);let t=F.get(e);t&&(clearTimeout(t),F.delete(e)),m.size===0&&Ae()}function Ce(e){if(!m.has(e))return;let t=async()=>{if(!(!m.has(e)||!U)){try{await U(e)}catch{}m.has(e)&&F.set(e,setTimeout(t,Te))}};t()}function xe(){A&&i.alarms.get(_,e=>{e||i.alarms.create(_,{periodInMinutes:.5})})}function Ae(){A&&i.alarms.clear(_)}var be=5*60*1e3,_e=10,de="send-to-dropcal",G="https://dropcal.ai",ke=24*60*60*1e3;L();async function J(){return new Promise(e=>{a.local.get("auth",t=>{e(t.auth||null)})})}async function Ee(e){await new Promise(t=>{a.local.set({auth:e},t)}),x(e.accessToken),Oe()}async function Oe(){try{let t=(await Y()).theme_mode||"auto";a.local.set({themeMode:t})}catch{}}async function k(){await new Promise(e=>{a.local.remove(["auth","themeMode"],e)}),x(null)}async function h(){let e=await J();return e?e.expiresAt&&Date.now()/1e3>e.expiresAt-60?(await k(),!1):(x(e.accessToken),!0):!1}async function O(){return new Promise(e=>{a.local.get("sessionHistory",t=>{e(t.sessionHistory||{sessions:[]})})})}async function ue(e){e.sessions=e.sessions.slice(0,_e),await new Promise(t=>{a.local.set({sessionHistory:e},t)}),z()}async function E(e){let t=await O();t.sessions=t.sessions.filter(r=>r.sessionId!==e.sessionId),t.sessions.unshift(e),await ue(t)}async function w(e,t){let r=await O(),o=r.sessions.findIndex(n=>n.sessionId===e);o!==-1&&(r.sessions[o]={...r.sessions[o],...t},await ue(r))}async function K(){return new Promise(e=>{a.local.get("notificationQueue",t=>{e(t.notificationQueue||[])})})}async function fe(e){await new Promise(t=>{a.local.set({notificationQueue:e},t)}),z()}async function H(e){let t=await K();t.includes(e)||(t.push(e),await fe(t))}async function Ne(e){let t=await K();await fe(t.filter(r=>r!==e))}i.runtime.onInstalled.addListener(()=>{i.contextMenus.create({id:de,title:"Send to DropCal",contexts:["selection","image"]}),Re()});async function Re(){return new Promise(e=>{a.session.get("activeJob",t=>{let r=t.activeJob;if(r&&r.sessionId&&r.status==="processed"){let o={sessionId:r.sessionId,status:"processed",title:r.sessionTitle||null,eventCount:r.eventCount,addedToCalendar:!1,eventSummaries:(r.events||[]).slice(0,3).map(n=>n.summary),events:r.events||[],createdAt:r.createdAt,inputType:"text"};E(o).then(()=>{a.session.remove("activeJob",()=>e())})}else e()})})}i.contextMenus.onClicked.addListener(async e=>{if(!(e.menuItemId!==de||!await h()))try{let r,o="text";if(e.selectionText)C(),r=await R(e.selectionText),o="text";else if(e.srcUrl)C(),r=await Q(e.srcUrl),o="image";else return;let n={sessionId:r.id,status:"polling",title:null,eventCount:0,addedToCalendar:!1,eventSummaries:[],events:[],createdAt:Date.now(),inputType:o};await E(n),P(r.id)}catch(r){console.error("DropCal: Failed to create session",r);let n=(r instanceof Error?r.message:"Unknown error").toLowerCase(),s=n.includes("401")||n.includes("403")||n.includes("authentication")||n.includes("jwt")||n.includes("token")||n.includes("expired");pe(),setTimeout(()=>z(),5e3),s&&await k()}});var y=new Map;M(async e=>{y.has(e)||y.set(e,Date.now());let t=y.get(e);if(Date.now()-t>be){S(e),y.delete(e),await w(e,{status:"error",errorMessage:"Processing timed out. Please try again."}),await H(e);return}try{let r=await W(e);if(r.status==="processed"){S(e),y.delete(e);let{events:n,count:s}=await V(e);await w(e,{status:"processed",title:r.title||null,icon:r.icon||null,eventCount:s,addedToCalendar:r.added_to_calendar,eventSummaries:n.slice(0,3).map(c=>c.summary),events:n}),await H(e),b.create(`dropcal-${e}`,{type:"basic",iconUrl:"icons/icon128.png",title:"DropCal",message:s===1?"1 event scheduled":`${s} events scheduled`}),d.tryOpenPopup();return}if(r.status==="error"){S(e),y.delete(e),await w(e,{status:"error",errorMessage:r.error_message||"Processing failed"}),await H(e);return}let o={};r.title&&(o.title=r.title),r.icon&&(o.icon=r.icon),Object.keys(o).length>0&&await w(e,o)}catch(r){console.error("DropCal: Poll error",r)}});var T=null;function C(){if(T!==null)return;let e=["\u280B","\u2819","\u2839","\u2838","\u283C","\u2834","\u2826","\u2827","\u2807","\u280F"],t=0;d.setBadgeBackgroundColor({color:"#1170C5"}),d.setBadgeText({text:e[0]}),T=setInterval(()=>{t=(t+1)%e.length,d.setBadgeText({text:e[t]})},350)}function X(){T!==null&&(clearInterval(T),T=null)}function De(e){X(),d.setBadgeText({text:String(e)}),d.setBadgeBackgroundColor({color:"#2e7d32"})}function pe(){X(),d.setBadgeText({text:"!"}),d.setBadgeBackgroundColor({color:"#c41e3a"})}function j(){X(),d.setBadgeText({text:""})}async function z(){let[e,t]=await Promise.all([O(),K()]),r=e.sessions;if(r.some(s=>s.status==="polling")){C();return}let o=0,n=!1;for(let s of t){let c=r.find(N=>N.sessionId===s);!c||c.dismissedAt||Date.now()-c.createdAt>ke||(c.status==="error"||c.status==="processed"&&c.eventCount===0?n=!0:c.status==="processed"&&(o+=c.eventCount))}if(n){pe();return}if(o>0){De(o);return}j()}i.runtime.onMessage.addListener((e,t,r)=>{if(e.type==="AUTH_TOKEN"){let{accessToken:o,refreshToken:n,expiresAt:s}=e;return Ee({accessToken:o,refreshToken:n,expiresAt:s}).then(()=>{r({ok:!0})}),!0}if(e.type==="THEME_CHANGED"){let o=e.themeMode||"auto";return a.local.set({themeMode:o}),r({ok:!0}),!1}if(e.type==="AUTH_SIGNED_OUT")return k().then(()=>r({ok:!0})),!0;if(e.type==="GET_STATUS")return Promise.all([new Promise(o=>{a.session.get("activeJob",o)}),J()]).then(([o,n])=>{r({job:o.activeJob||null,isAuthenticated:!!n})}),!0;if(e.type==="GET_AUTH")return J().then(o=>{r({isAuthenticated:!!o})}),!0;if(e.type==="SIGN_IN"){let o=encodeURIComponent("Sign in to start creating events.");return i.tabs.create({url:`${G}/?auth=${o}`}),r({ok:!0}),!1}if(e.type==="OPEN_SESSION"){let{sessionId:o}=e,n=`${G}/s/${o}`;return i.tabs.create({url:n}),r({ok:!0}),!1}if(e.type==="CLEAR_JOB")return a.session.remove("activeJob"),j(),r({ok:!0}),!1;if(e.type==="SUBMIT_TEXT"){let{text:o}=e;return h().then(async n=>{if(!n){r({ok:!1,error:"Not authenticated"});return}try{C();let s=await R(o),c={sessionId:s.id,status:"polling",title:null,eventCount:0,addedToCalendar:!1,eventSummaries:[],events:[],createdAt:Date.now(),inputType:"text"};await E(c),P(s.id),r({ok:!0})}catch(s){console.error("DropCal: Submit text failed",s),j(),r({ok:!1})}}),!0}if(e.type==="TRACK_SESSION"){let{sessionId:o,inputType:n}=e;C();let s={sessionId:o,status:"polling",title:null,eventCount:0,addedToCalendar:!1,eventSummaries:[],events:[],createdAt:Date.now(),inputType:n||"file"};return E(s).then(()=>{P(o),r({ok:!0})}),!0}if(e.type==="GET_HISTORY")return O().then(o=>{r({sessions:o.sessions})}),!0;if(e.type==="OPEN_SIDEBAR"){let{sessionId:o}=e;return i.windows.getLastFocused().then(n=>{n.id&&B.open({windowId:n.id,sessionId:o}).catch(()=>{})}),r({ok:!0}),!1}if(e.type==="GET_USER_PROFILE")return h().then(async o=>{if(!o){r({ok:!1,error:"Not authenticated"});return}try{let n=await q();r({ok:!0,profile:n})}catch(n){console.error("DropCal: Failed to get profile",n),r({ok:!1,error:"Failed to load profile"})}}),!0;if(e.type==="UPDATE_PREFERENCES")return h().then(async o=>{if(!o){r({ok:!1,error:"Not authenticated"});return}try{let n=await Z(e.preferences);e.preferences.theme_mode&&a.local.set({themeMode:e.preferences.theme_mode}),r({ok:!0,preferences:n.preferences})}catch(n){console.error("DropCal: Failed to update preferences",n),r({ok:!1,error:"Failed to save preferences"})}}),!0;if(e.type==="GET_CALENDAR_PROVIDERS")return h().then(async o=>{if(!o){r({ok:!1,error:"Not authenticated"});return}try{let n=await ee();r({ok:!0,providers:n.providers})}catch(n){console.error("DropCal: Failed to get providers",n),r({ok:!1,error:"Failed to load providers"})}}),!0;if(e.type==="SET_PRIMARY_PROVIDER")return h().then(async o=>{if(!o){r({ok:!1,error:"Not authenticated"});return}try{await te(e.provider),r({ok:!0})}catch(n){console.error("DropCal: Failed to set primary",n),r({ok:!1,error:"Failed to set primary provider"})}}),!0;if(e.type==="DISCONNECT_PROVIDER")return h().then(async o=>{if(!o){r({ok:!1,error:"Not authenticated"});return}try{await re(e.provider),r({ok:!0})}catch(n){console.error("DropCal: Failed to disconnect",n),r({ok:!1,error:"Failed to disconnect provider"})}}),!0;if(e.type==="DISMISS_SESSION"){let{sessionId:o}=e;return Promise.all([Ne(o),w(o,{dismissedAt:Date.now()})]).then(()=>{r({ok:!0})}),!0}return e.type==="SIGN_OUT"?(k().then(()=>{r({ok:!0})}),!0):!1});b.onClicked.addListener(async e=>{if(!e.startsWith("dropcal-"))return;let t=e.replace("dropcal-","");a.session.set({sidebarSessionId:t});let r=`${G}/s/${t}`;i.tabs.create({url:r})});
//# sourceMappingURL=background.js.map
