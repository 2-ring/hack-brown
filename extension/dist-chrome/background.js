var d="https://api.dropcal.ai",w=null;function k(e){w=e}function p(){let e={"Content-Type":"application/json"};return w&&(e.Authorization=`Bearer ${w}`),e}async function u(e){if(!e.ok){let t=await e.json().catch(()=>({error:e.statusText}));throw new Error(t.error||`HTTP ${e.status}`)}return e.json()}async function R(e){let t=await fetch(`${d}/sessions`,{method:"POST",headers:p(),body:JSON.stringify({text:e})});return(await u(t)).session}async function W(e){let t=await fetch(e);if(!t.ok)throw new Error(`Failed to fetch image: ${t.status}`);let r=await t.blob(),n=new URL(e).pathname.split("/").pop()||"image.png",s=new FormData;s.append("file",r,n);let c={};w&&(c.Authorization=`Bearer ${w}`);let m=await fetch(`${d}/upload`,{method:"POST",headers:c,body:s});return(await u(m)).session}async function Y(e){let t=await fetch(`${d}/sessions/${e}`,{method:"GET",headers:p()});return(await u(t)).session}async function q(e){let t=await fetch(`${d}/sessions/${e}/events`,{method:"GET",headers:p()});return u(t)}async function Z(){let e=await fetch(`${d}/auth/profile`,{method:"GET",headers:p()});return(await u(e)).user.preferences||{}}async function ee(){let e=await fetch(`${d}/auth/profile`,{method:"GET",headers:p()}),t=await u(e);return{email:t.user.email,display_name:t.user.display_name,photo_url:t.user.photo_url,plan:t.user.plan||"free",primary_calendar_provider:t.user.primary_calendar_provider,preferences:t.user.preferences||{}}}async function te(e){let t=await fetch(`${d}/auth/preferences`,{method:"PUT",headers:p(),body:JSON.stringify(e)});return u(t)}async function re(){let e=await fetch(`${d}/calendar/provider/list`,{method:"GET",headers:p()});return u(e)}async function oe(e){let t=await fetch(`${d}/calendar/provider/set-primary`,{method:"POST",headers:p(),body:JSON.stringify({provider:e})});await u(t)}async function ne(e){let t=await fetch(`${d}/calendar/provider/disconnect`,{method:"POST",headers:p(),body:JSON.stringify({provider:e})});await u(t)}async function ie(e,t){let r=await fetch(`${d}/events/push`,{method:"POST",headers:p(),body:JSON.stringify({event_ids:t,session_id:e})});return u(r)}var l=globalThis.chrome,me=typeof browser<"u",i=me?browser:l,se=typeof l<"u"&&"sidePanel"in l,ye=typeof browser<"u"&&typeof browser.sidebarAction?.open=="function",$=typeof l<"u"&&typeof l.storage<"u"&&"session"in l.storage,L=typeof l<"u"&&"notifications"in l,ae=typeof l<"u"&&typeof l.action?.openPopup=="function",E=typeof l<"u"&&"alarms"in l;var h="__session:";function ce(e){return typeof e=="string"?[`${h}${e}`]:Array.isArray(e)?e.map(t=>`${h}${t}`):Object.keys(e).map(t=>`${h}${t}`)}function le(e){let t={};for(let[r,o]of Object.entries(e))t[`${h}${r}`]=o;return t}function Pe(e){let t={};for(let[r,o]of Object.entries(e))r.startsWith(h)&&(t[r.slice(h.length)]=o);return t}var B=new Set,de=!1;function Se(){de||(de=!0,i.storage.local.onChanged.addListener(e=>{if(B.size===0)return;let t={},r=!1;for(let[o,n]of Object.entries(e))o.startsWith(h)&&(t[o.slice(h.length)]=n,r=!0);if(r)for(let o of B)o(t,"session")}))}var ue={get(e,t){let r=e===null?null:ce(e);i.storage.local.get(r,o=>{t(Pe(o))})},set(e,t){t?i.storage.local.set(le(e),t):i.storage.local.set(le(e))},remove(e,t){let r=ce(e);t?i.storage.local.remove(r,t):i.storage.local.remove(r)},clear(e){i.storage.local.get(null,t=>{let r=Object.keys(t).filter(o=>o.startsWith(h));r.length>0?e?i.storage.local.remove(r,e):i.storage.local.remove(r):e?.()})},onChanged:{addListener(e){Se(),B.add(e)}}};function U(){$||ue.clear()}function we(){let e=i.storage.session;return{get(t,r){e.get(t,r)},set(t,r){r?e.set(t,r):e.set(t)},remove(t,r){r?e.remove(t,r):e.remove(t)},clear(t){t?e.clear(t):e.clear()},onChanged:e.onChanged}}var a={local:i.storage.local,session:$?we():ue,onChanged:i.storage.onChanged};var O={create(e,t){L&&i.notifications.create(e,t)},onClicked:L?i.notifications.onClicked:{addListener:e=>{}}};function Te(){return{isSupported:!0,async open({windowId:e,sessionId:t}){t&&await new Promise(r=>{a.session.set({sidebarSessionId:t},r)}),e&&await i.sidePanel.open({windowId:e})}}}function Ce(){return{isSupported:!0,async open({sessionId:e}){await browser.sidebarAction.open(),e&&a.session.set({sidebarSessionId:e})}}}var F=se?Te():Ce();var f={setBadgeText(e){i.action.setBadgeText(e)},setBadgeBackgroundColor(e){i.action.setBadgeBackgroundColor(e)},async tryOpenPopup(){if(ae)try{await i.action.openPopup()}catch{}}};var Qe=1/30,Ae=2e3,N="poll-keepalive",M=null,y=new Set,H=new Map;function J(e){M=e,E&&i.alarms.onAlarm.addListener(t=>{t.name})}function T(e){y.add(e),be(),xe(e)}function C(e){y.delete(e);let t=H.get(e);t&&(clearTimeout(t),H.delete(e)),y.size===0&&_e()}function xe(e){if(!y.has(e))return;let t=async()=>{if(!(!y.has(e)||!M)){try{await M(e)}catch{}y.has(e)&&H.set(e,setTimeout(t,Ae))}};t()}function be(){E&&i.alarms.get(N,e=>{e||i.alarms.create(N,{periodInMinutes:.5})})}function _e(){E&&i.alarms.clear(N)}var ke=5*60*1e3,Ee=10,fe="send-to-dropcal",j="https://dropcal.ai",Oe=24*60*60*1e3;U();async function K(){return new Promise(e=>{a.local.get("auth",t=>{e(t.auth||null)})})}async function Ne(e){await new Promise(t=>{a.local.set({auth:e},t)}),k(e.accessToken),De()}async function De(){try{let t=(await Z()).theme_mode||"auto";a.local.set({themeMode:t})}catch{}}async function D(){await new Promise(e=>{a.local.remove(["auth","themeMode"],e)}),k(null)}async function g(){let e=await K();return e?e.expiresAt&&Date.now()/1e3>e.expiresAt-60?(await D(),!1):(k(e.accessToken),!0):!1}async function x(){return new Promise(e=>{a.local.get("sessionHistory",t=>{e(t.sessionHistory||{sessions:[]})})})}async function pe(e){e.sessions=e.sessions.slice(0,Ee),await new Promise(t=>{a.local.set({sessionHistory:e},t)}),V()}async function I(e){let t=await x();t.sessions=t.sessions.filter(r=>r.sessionId!==e.sessionId),t.sessions.unshift(e),await pe(t)}async function P(e,t){let r=await x(),o=r.sessions.findIndex(n=>n.sessionId===e);o!==-1&&(r.sessions[o]={...r.sessions[o],...t},await pe(r))}async function z(){return new Promise(e=>{a.local.get("notificationQueue",t=>{e(t.notificationQueue||[])})})}async function he(e){await new Promise(t=>{a.local.set({notificationQueue:e},t)}),V()}async function G(e){let t=await z();t.includes(e)||(t.push(e),await he(t))}async function Ie(e){let t=await z();await he(t.filter(r=>r!==e))}i.runtime.onInstalled.addListener(()=>{i.contextMenus.create({id:fe,title:"Send to DropCal",contexts:["selection","image"]}),Re()});async function Re(){return new Promise(e=>{a.session.get("activeJob",t=>{let r=t.activeJob;if(r&&r.sessionId&&r.status==="processed"){let o={sessionId:r.sessionId,status:"processed",title:r.sessionTitle||null,eventCount:r.eventCount,addedToCalendar:!1,eventSummaries:(r.events||[]).slice(0,3).map(n=>n.summary),events:r.events||[],createdAt:r.createdAt,inputType:"text"};I(o).then(()=>{a.session.remove("activeJob",()=>e())})}else e()})})}i.contextMenus.onClicked.addListener(async e=>{if(!(e.menuItemId!==fe||!await g()))try{let r,o="text";if(e.selectionText)b(),r=await R(e.selectionText),o="text";else if(e.srcUrl)b(),r=await W(e.srcUrl),o="image";else return;let n={sessionId:r.id,status:"polling",title:null,eventCount:0,addedToCalendar:!1,eventSummaries:[],events:[],createdAt:Date.now(),inputType:o};await I(n),T(r.id)}catch(r){console.error("DropCal: Failed to create session",r);let n=(r instanceof Error?r.message:"Unknown error").toLowerCase(),s=n.includes("401")||n.includes("403")||n.includes("authentication")||n.includes("jwt")||n.includes("token")||n.includes("expired");ge(),setTimeout(()=>V(),5e3),s&&await D()}});var v=new Map;J(async e=>{v.has(e)||v.set(e,Date.now());let t=v.get(e);if(Date.now()-t>ke){C(e),v.delete(e),await P(e,{status:"error",errorMessage:"Processing timed out. Please try again."}),await G(e);return}try{let r=await Y(e);if(r.status==="processed"){C(e),v.delete(e);let{events:n,count:s}=await q(e);await P(e,{status:"processed",title:r.title||null,icon:r.icon||null,eventCount:s,addedToCalendar:r.added_to_calendar,eventSummaries:n.slice(0,3).map(c=>c.summary),events:n}),await G(e),O.create(`dropcal-${e}`,{type:"basic",iconUrl:"icons/icon128.png",title:"DropCal",message:s===1?"1 event scheduled":`${s} events scheduled`}),f.tryOpenPopup();return}if(r.status==="error"){C(e),v.delete(e),await P(e,{status:"error",errorMessage:r.error_message||"Processing failed"}),await G(e);return}let o={};r.title&&(o.title=r.title),r.icon&&(o.icon=r.icon),Object.keys(o).length>0&&await P(e,o)}catch(r){console.error("DropCal: Poll error",r)}});var A=null;function b(){if(A!==null)return;let e=["\u280B","\u2819","\u2839","\u2838","\u283C","\u2834","\u2826","\u2827","\u2807","\u280F"],t=0;f.setBadgeBackgroundColor({color:"#1170C5"}),f.setBadgeText({text:e[0]}),A=setInterval(()=>{t=(t+1)%e.length,f.setBadgeText({text:e[t]})},350)}function Q(){A!==null&&(clearInterval(A),A=null)}function $e(e){Q(),f.setBadgeText({text:String(e)}),f.setBadgeBackgroundColor({color:"#2e7d32"})}function ge(){Q(),f.setBadgeText({text:"!"}),f.setBadgeBackgroundColor({color:"#c41e3a"})}function X(){Q(),f.setBadgeText({text:""})}async function V(){let[e,t]=await Promise.all([x(),z()]),r=e.sessions;if(r.some(s=>s.status==="polling")){b();return}let o=0,n=!1;for(let s of t){let c=r.find(m=>m.sessionId===s);!c||c.dismissedAt||Date.now()-c.createdAt>Oe||(c.status==="error"||c.status==="processed"&&c.eventCount===0?n=!0:c.status==="processed"&&(o+=c.eventCount))}if(n){ge();return}if(o>0){$e(o);return}X()}i.runtime.onMessage.addListener((e,t,r)=>{if(e.type==="AUTH_TOKEN"){let{accessToken:o,refreshToken:n,expiresAt:s}=e;return Ne({accessToken:o,refreshToken:n,expiresAt:s}).then(()=>{r({ok:!0})}),!0}if(e.type==="THEME_CHANGED"){let o=e.themeMode||"auto";return a.local.set({themeMode:o}),r({ok:!0}),!1}if(e.type==="AUTH_SIGNED_OUT")return D().then(()=>r({ok:!0})),!0;if(e.type==="GET_STATUS")return Promise.all([new Promise(o=>{a.session.get("activeJob",o)}),K()]).then(([o,n])=>{r({job:o.activeJob||null,isAuthenticated:!!n})}),!0;if(e.type==="GET_AUTH")return K().then(o=>{r({isAuthenticated:!!o})}),!0;if(e.type==="SIGN_IN"){let o=encodeURIComponent("Sign in to start creating events.");return i.tabs.create({url:`${j}/?auth=${o}`}),r({ok:!0}),!1}if(e.type==="OPEN_SESSION"){let{sessionId:o}=e,n=`${j}/s/${o}`;return i.tabs.create({url:n}),r({ok:!0}),!1}if(e.type==="CLEAR_JOB")return a.session.remove("activeJob"),X(),r({ok:!0}),!1;if(e.type==="SUBMIT_TEXT"){let{text:o}=e;return g().then(async n=>{if(!n){r({ok:!1,error:"Not authenticated"});return}try{b();let s=await R(o),c={sessionId:s.id,status:"polling",title:null,eventCount:0,addedToCalendar:!1,eventSummaries:[],events:[],createdAt:Date.now(),inputType:"text"};await I(c),T(s.id),r({ok:!0})}catch(s){console.error("DropCal: Submit text failed",s),X(),r({ok:!1})}}),!0}if(e.type==="TRACK_SESSION"){let{sessionId:o,inputType:n}=e;b();let s={sessionId:o,status:"polling",title:null,eventCount:0,addedToCalendar:!1,eventSummaries:[],events:[],createdAt:Date.now(),inputType:n||"file"};return I(s).then(()=>{T(o),r({ok:!0})}),!0}if(e.type==="GET_HISTORY")return x().then(o=>{r({sessions:o.sessions})}),!0;if(e.type==="OPEN_SIDEBAR"){let{sessionId:o}=e;return i.windows.getLastFocused().then(n=>{n.id&&F.open({windowId:n.id,sessionId:o}).catch(()=>{})}),r({ok:!0}),!1}if(e.type==="GET_USER_PROFILE")return g().then(async o=>{if(!o){r({ok:!1,error:"Not authenticated"});return}try{let n=await ee();r({ok:!0,profile:n})}catch(n){console.error("DropCal: Failed to get profile",n),r({ok:!1,error:"Failed to load profile"})}}),!0;if(e.type==="UPDATE_PREFERENCES")return g().then(async o=>{if(!o){r({ok:!1,error:"Not authenticated"});return}try{let n=await te(e.preferences);e.preferences.theme_mode&&a.local.set({themeMode:e.preferences.theme_mode}),r({ok:!0,preferences:n.preferences})}catch(n){console.error("DropCal: Failed to update preferences",n),r({ok:!1,error:"Failed to save preferences"})}}),!0;if(e.type==="GET_CALENDAR_PROVIDERS")return g().then(async o=>{if(!o){r({ok:!1,error:"Not authenticated"});return}try{let n=await re();r({ok:!0,providers:n.providers})}catch(n){console.error("DropCal: Failed to get providers",n),r({ok:!1,error:"Failed to load providers"})}}),!0;if(e.type==="SET_PRIMARY_PROVIDER")return g().then(async o=>{if(!o){r({ok:!1,error:"Not authenticated"});return}try{await oe(e.provider),r({ok:!0})}catch(n){console.error("DropCal: Failed to set primary",n),r({ok:!1,error:"Failed to set primary provider"})}}),!0;if(e.type==="DISCONNECT_PROVIDER")return g().then(async o=>{if(!o){r({ok:!1,error:"Not authenticated"});return}try{await ne(e.provider),r({ok:!0})}catch(n){console.error("DropCal: Failed to disconnect",n),r({ok:!1,error:"Failed to disconnect provider"})}}),!0;if(e.type==="DISMISS_SESSION"){let{sessionId:o}=e;return Promise.all([Ie(o),P(o,{dismissedAt:Date.now()})]).then(()=>{r({ok:!0})}),!0}if(e.type==="PUSH_ALL_EVENTS"){let{sessionId:o}=e;return(async()=>{if(!await g())return{ok:!1,error:"Not authenticated"};let m=((await x()).sessions.find(S=>S.sessionId===o)?.events||[]).map(S=>S.id).filter(S=>!!S);if(m.length===0)return{ok:!1,error:"No events to add"};let _=await ie(o,m);return _.success&&await P(o,{addedToCalendar:!0}),{ok:_.success,message:_.message}})().then(n=>r(n)).catch(n=>{console.error("DropCal: Push events failed",n),r({ok:!1,error:"Failed to add events to calendar"})}),!0}return e.type==="SIGN_OUT"?(D().then(()=>{r({ok:!0})}),!0):!1});O.onClicked.addListener(async e=>{if(!e.startsWith("dropcal-"))return;let t=e.replace("dropcal-","");a.session.set({sidebarSessionId:t});let r=`${j}/s/${t}`;i.tabs.create({url:r})});
//# sourceMappingURL=background.js.map
