files:
  /opt/duckling/setup.sh:
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      set -e
      exec &>/var/log/duckling-setup.log

      echo "[$(date)] Starting Duckling setup..."

      # Install Docker
      if ! command -v docker &>/dev/null; then
        echo "[$(date)] Installing Docker..."
        dnf install -y docker
      fi

      echo "[$(date)] Starting Docker daemon..."
      systemctl enable docker
      systemctl start docker

      # Wait for Docker daemon
      for i in $(seq 1 30); do
        docker info &>/dev/null && break
        sleep 1
      done

      # Install systemd unit for reboot persistence
      cat > /etc/systemd/system/duckling.service <<'UNIT'
      [Unit]
      Description=Duckling temporal parsing service
      After=docker.service
      Requires=docker.service

      [Service]
      Type=oneshot
      RemainAfterExit=yes
      ExecStartPre=-/usr/bin/docker stop duckling
      ExecStartPre=-/usr/bin/docker rm duckling
      ExecStart=/usr/bin/docker run -d --name duckling --restart always -p 8050:8000 rasa/duckling
      ExecStop=/usr/bin/docker stop duckling
      ExecStopPost=-/usr/bin/docker rm duckling

      [Install]
      WantedBy=multi-user.target
      UNIT

      systemctl daemon-reload
      systemctl enable duckling.service

      # Pull image and start
      echo "[$(date)] Pulling rasa/duckling image..."
      docker rm -f duckling 2>/dev/null || true
      docker pull rasa/duckling

      echo "[$(date)] Starting Duckling container on port 8050..."
      docker run -d --name duckling --restart always -p 8050:8000 rasa/duckling

      echo "[$(date)] Duckling setup complete"

commands:
  01_start_duckling_bg:
    command: |
      # Clear any leftover unit from a previous failed deploy
      systemctl stop duckling-setup 2>/dev/null || true
      systemctl reset-failed duckling-setup 2>/dev/null || true
      # systemd-run delegates to PID 1 (systemd), escaping EB's process
      # tracking so the deploy isn't blocked by Docker install/image pull.
      systemd-run --unit=duckling-setup --description="Duckling Docker Setup" /opt/duckling/setup.sh
      echo "Duckling setup started as transient systemd unit"
